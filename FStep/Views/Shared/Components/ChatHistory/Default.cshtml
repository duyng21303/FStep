<body>
<button class="open-button" onclick="openForm()">Chat</button>
<div class="chat-popup" id="myForm">
	<div class="container">
		<div class="row clearfix">
			<div class="card chat-app">
				<div id="plist" class="people-list">
					<div class="input-group">
						<!-- Các phần tử trong people-list -->
					</div>
					<ul class="list-unstyled chat-list mt-2 mb-0">
						<li class="clearfix">
							<img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="avatar">
							<div class="about">
								<div class="name">Vincent Porter</div>
								<div class="status"> <i class="fa fa-circle offline"></i> left 7 mins ago </div>
							</div>
						</li>
						@{
							var usersProcessed = new HashSet<string>();
						}
						@foreach (var user in Model)
						{
							var userId_Send = user.SenderUser.IdUser;
							var userId_Recieve = user.RecieverUser.IdUser;
							// Kiểm tra xem userId của người dùng đã được xử lý trước đó hay chưa
							if (!usersProcessed.Contains(userId_Send) && !usersProcessed.Contains(userId_Recieve))
							{
								// Thêm userId vào danh sách đã xử lý

								@if (user.SenderUser.IdUser != User.Claims.FirstOrDefault(c => c.Type == "UserID")?.Value)
								{
									@* <a asp-action="Chat" asp-controller="Chat" asp-route-idUser="@user.SenderUser.IdUser"> *@
									<li class="clearfix" onclick="openChat(@user.SenderUser.IdUser, @user.SenderUser.Name, @user.SenderUser.AvatarImg)">
										<img src="~/img/userAvar/@user.SenderUser.AvatarImg" alt="avatar">
										<div class="about">
											<div class="name">@(@user.SenderUser.Name.Length > 16 ? @user.SenderUser.Name.Substring(0, 16) + "..." : @user.SenderUser.Name)</div>
											<div class="status"> <i class="fa fa-circle online"></i> online </div>
										</div>
									</li>
									usersProcessed.Add(userId_Send);
									@* </a> *@
								}
								else
								{
									@* <a asp-action="Chat" asp-controller="Chat" asp-route-idUser="@user.RecieverUser.IdUser"> *@
									<li class="clearfix" onclick="openChat(@user.RecieverUser.IdUser, @user.RecieverUser.Name, @user.RecieverUser.AvatarImg)">
										<img src="~/img/userAvar/@user.RecieverUser.AvatarImg" alt="avatar">
										<div class="about">
											<div class="name">@(@user.RecieverUser.Name.Length > 16 ? @user.RecieverUser.Name.Substring(0, 16) + "..." : @user.RecieverUser.Name)</div>
											<div class="status"> <i class="fa fa-circle online"></i> online </div>
										</div>
									</li>
									@* </a> *@

									usersProcessed.Add(userId_Recieve);
								}
							}
						}
					</ul>
				</div>
				<div class="chat">
					<div class="chat-header clearfix">
						<div class="row">
							<div class="col-lg-10 header-message">
								<a href="javascript:void(0);" data-toggle="modal" data-target="#view_info">
									<img src="https://bootdey.com/img/Content/avatar/avatar2.png" alt="avatar">
								</a>
								<div class="chat-about">
									<h7 class="m-b-0">Aiden Chavez</h7><br>
									<small>Last seen: 2 hours ago</small>
								</div>
							</div>
							<div class="col-lg-2 hidden-sm close">
								<button onclick="closeForm()" class="btn btn-outline-warning float-right">
									X
								</button>
							</div>
						</div>
					</div>
					<div class="chat-history">
						<ul class="m-b-0">
							<li class="clearfix">
								<div class="message-data float-right">
									<span class="message-data-time">10:10 AM, Today</span>
								</div>
								<br>
								<div class="message other-message float-right"> Hi Aiden, how are you? How is the project coming along? </div>
							</li>
							<li class="clearfix">
								<div class="message-data">
									<img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
									<span class="message-data-time">10:12 AM, Today</span>
								</div>
								<div class="message my-message">Are we meeting today?</div>
							</li>
							<li class="clearfix">
								<div class="message-data">
									<img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
									<span class="message-data-time">10:15 AM, Today</span>
								</div>
								<div class="message my-message">Project has been already finished and I have results to show you.</div>
							</li>
						</ul>
					</div>
					<div class="chat-message clearfix">
						<div class="input-group mb-0">
							<input type="text" class="form-control" placeholder="Enter text here...">
							<div class="input-group-append">
								<button class="btn btn-primary" type="button">Gửi</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	function openForm() {
		document.getElementById("myForm").style.display = "block";
	}

	function closeForm() {
		document.getElementById("myForm").style.display = "none";
	}
	function openChat(userId, userName, userAvatar) {
		openForm();
		document.getElementById("chatHeaderName").innerText = userName;
		document.getElementById("chatHeaderAvatar").src = userAvatar;

		// Gửi yêu cầu AJAX để tải nội dung chat
		$.ajax({
			url: '/Chat/GetChat',
			type: 'GET',
			data: { idUser: userId },
			success: function (data) {
				document.getElementById("chatHistory").innerHTML = data;
			}
		});
	}
</script>

</body>