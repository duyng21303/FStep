@model X.PagedList.IPagedList<FStep.ViewModels.WareHouse.WareHouseVM>
@using X.PagedList.Mvc.Core;
@{
	var format = System.Globalization.CultureInfo.GetCultureInfo("vi-VN");
}

<div class="container py-5">
	<div class="py-3">
		<h1 class="exchange-title">Danh sách giao dịch</h1>
	</div>
	<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
		<li class="nav-item" role="presentation">
			<button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-all" type="button" role="tab" aria-controls="pills-home" aria-selected="true">Tất cả</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-processing" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">Chờ giao hàng</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-completed" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Hoàn thành</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-canceled" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Đã huỷ</button>
		</li>
	</ul>
	<div class="tab-content" id="pills-tabContent">
		<div class="tab-pane fade show active" id="pills-all" role="tabpanel" aria-labelledby="pills-home-tab">

			<div class="row align-items-center mb-4 search-header">
				<div class="col-md-12">
					<form asp-action="WareHouse" asp-controller="WareHouse" method="get" class="d-flex justify-content-end search-form">
						<input type="search" class="form-control search-input" placeholder="transaction code" name="query">
						<button class="btn btn-primary search-button" type="submit">
							<i class="fa fa-search search-icon"></i>
						</button>
					</form>
				</div>
			</div>
			<!-- Start Content Body-->
			<div class="row align-items-center mb-8 search-header">
				<div class="custom-container">
					<div class="container">
						<div class="row mt-3">
							<div class="col">
								<table class="table table-striped table-bordered">
									<thead class="thead-light">
										<tr>
											<th scope="col">Mã Số</th>
											<th scope="col">Vị Trí</th>
											<th scope="col">Mã Giao Dịch</th>
											<th scope="col">Ngày</th>
											<th scope="col">Người Mua</th>
											<th scope="col">Người Bán</th>
											<th scope="col">Tên Sản Phẩm</th>
											<th scope="col">Số Lượng</th>
											<th scope="col">Tổng Tiền</th>
											<th scope="col">Trạng thái</th>
											<th scope="col">Giao Dịch</th>
											<th scope="col">Chỉnh sửa</th>
										</tr>
									</thead>
									<tbody>
										@foreach (var item in Model)
										{
											<form asp-controller="WareHouse" asp-action="CompleteTransaction" asp-route-code="@item.CodeTransaction">
											<tr>
												<td class="post-title">@Html.Raw(item.PostVM.IdPost)</td>
												<td><input name="location" value="@Html.Raw(item.Location)" type="text" /></td>
												<td style="color:red">@Html.Raw(item.CodeTransaction)</td>
												<td>@Html.Raw(item.Date)</td>
												<td style="color:red">@item.IdStudentSeller</td>
												<td style="color:red">@Html.Raw(item.IdStudentBuyer)</td>
												<td>@Html.Raw(item.NameProduct)</td>
												<td>@Html.Raw(item.Quantity)</td>
												<th style="color:red">@String.Format(format, "{0:0,0 VND}", item.Amount)</th>
												<td>@item.Status</td>
												<td>
														@* <form asp-controller="" asp-action="Pay" method="post" asp-route-id="@item.CodeTransaction">
												<input type="hidden" name="id" value="" />
												<button type="submit" class="btn btn-danger btn-sm">Hoàn thành</button>
												</form> *@
														@if (item.Status == "Completed")
														{
														<button disabled class="btn btn-sm bg-dark text-light bg-opacity-50">Hoàn thành</button>
														}
														else
														{
														<a asp-controller="WareHouse" asp-action="CompleteTransaction" asp-route-code="@item.CodeTransaction" class="btn btn-danger btn-sm">Hoàn thành</a>
														}
													</td>
												<td>
													<button type="submit" class="btn btn-info btn-sm">Chỉnh sửa</button>
												</td>
											</tr>
											</form>
										}
									</tbody>
								</table>
							</div>
						</div>
					</div>
					@Html.PagedListPager(Model, page => Url.Action("WareHouse", new { query = ViewBag.Query, page = page }))
				</div>
			</div>
			<!-- End Show -->
			@* <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-lg">

					<!-- Tab panes -->
					<!-- Tab panes -->
					<div class="tab-content" id="myTabContent">
						<div class="tab-pane fade @(ViewBag.ActiveTab == "exchange" ? "show active" : "")" id="exchange" role="tabpanel" aria-labelledby="exchange-tab">
							<h3>Exchange</h3>
							<table class="table table-striped table-bordered">
								<thead class="thead-light">
									<tr>
										<th scope="col">Code Transaction</th>
										<th scope="col">Location</th>
										<th scope="col">Date</th>
										<th scope="col">Id UserB</th>
										<th scope="col">Id UserE</th>
										<th scope="col">Name Product</th>
										<th scope="col">Action</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var item in Model.ExchangeList)
									{
										<tr data-id="@item.TransactionVM.TransactionId" data-type="@item.Type">
											<td>@Html.DisplayFor(modelItem => item.TransactionVM.CodeTransaction)</td>
											<td>@Html.DisplayFor(modelItem => item.Location)</td>
											<td>@Html.DisplayFor(modelItem => item.TransactionVM.CreateDate)</td>
											<td>@Html.DisplayFor(moderItem => item.UserBuyer.IdUser)</td>
											<form asp-action="RecieveImg" enctype="multipart/form-data">
											<td>
												<label class="btn btn-primary">
													Upload new image
													<input type="file" name="img" style="display: none;" onchange="this.form.submit()">
													<input type="hidden" name="type" value="Buyer" />
													<input type="hidden" name="id" value="@item.TransactionVM.TransactionId" />
												</label>
											</td>
											</form>
											<td>@Html.DisplayFor(modelItem => item.UserSeller.IdUser)</td>
											<form asp-action="RecieveImg" enctype="multipart/form-data">
											<td>
												<label class="btn btn-primary">
													Upload new image
													<input type="file" name="img" style="display: none;" onchange="this.form.submit()">
													<input type="hidden" name="type" value="Seller" />
													<input type="hidden" name="id" value="@item.TransactionVM.TransactionId" />
												</label>
											</td>
											</form>
											<td>@Html.DisplayFor(modelItem => item.PostVM.Title)</td>
											<td>
												<button type="button" class="btn btn-danger btn-sm submit-img" data-toggle="collapse" data-target="#confirmCollapse-@item.TransactionVM.TransactionId">Confirm</button>
											</td>

										</tr>
										<tr id="confirmCollapse-@item.TransactionVM.TransactionId" class="collapse">
											<td colspan="9">
												<div class="card card-body">
													<!-- Your collapsible content here -->
													<p>Are you sure you want to confirm this transaction?</p>
													<button type="button" class="btn btn-success">Yes</button>
													<button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#confirmCollapse-@item.TransactionVM.TransactionId">No</button>
												</div>
												<div class="card card-body">
													<!-- Your collapsible content here -->
													<p>Are you sure you want to confirm this transaction?</p>
													<button type="button" class="btn btn-success">Yes</button>
													<button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#confirmCollapse-@item.TransactionVM.TransactionId">No</button>
												</div>
											</td>
										</tr>
									}
								</tbody>
							</table>

		</div>
		<div class="tab-pane fade" id="pills-completed" role="tabpanel" aria-labelledby="pills-contact-tab">

						<div class="tab-pane fade @(ViewBag.ActiveTab == "sale" ? "show active" : "")" id="sale" role="tabpanel" aria-labelledby="sale-tab">
							<h3>Sale</h3>
							<table class="table table-striped table-bordered">
								<thead class="thead-light">
									<tr>
										<th scope="col">Id Post</th>
										<th scope="col">Location</th>
										<th scope="col">Code Transaction</th>
										<th scope="col">Date</th>
										<th scope="col">Id User Buyer</th>
										<th scope="col">Name Product</th>
										<th scope="col">Quantity</th>
										<th scope="col">Amount</th>
										<th scope="col">Action</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var item in Model.SaleList)
									{
										<tr data-id="@item.TransactionVM.TransactionId" data-type="@item.Type">
											<td>@Html.DisplayFor(modelItem => item.PostVM.IdPost)</td>
											<td>@Html.DisplayFor(modelItem => item.Location)</td>
											<td>@Html.DisplayFor(modelItem => item.TransactionVM.CodeTransaction)</td>
											<td>@Html.DisplayFor(modelItem => item.TransactionVM.CreateDate)</td>
											<td>@Html.DisplayFor(moderItem => item.UserBuyer.IdUser)</td>
											<td>@Html.DisplayFor(modelItem => item.UserSeller.IdUser)</td>
											<td>@Html.DisplayFor(modelItem => item.PostVM.Title)</td>
											<td>@Html.DisplayFor(modelItem => item.TransactionVM.Quantity)</td>
											<td>@Html.DisplayFor(modelItem => item.TransactionVM.Amount)</td>
											<td>
												<button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#confirmModal">Confirm</button>
											</td>
										</tr>
									}
								</tbody>
							</table>

							@Html.PagedListPager(Model.SaleList, page => Url.Action("WareHouse", new { page, searchString = ViewBag.SearchString, activeTab = "sale" }))
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="infoModalLabel">Thông tin chi tiết</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="modal-body-content">
				<!-- Nội dung sẽ được tải từ view khác -->
			</div>
			<!-- End Show -->
			@* <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-lg">

			@await Html.PartialAsync("Feedback", new FeedbackVM())

			</div>
			</div> *@
		</div>
	</div>

</div>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', function () {
		// Lấy tất cả các thẻ <tr> có thuộc tính data-id
		var trs = document.querySelectorAll('tr[data-id][data-type]');

		// Thêm sự kiện click vào mỗi thẻ <tr>
		trs.forEach(function (tr) {
			tr.addEventListener('click', function () {
				if (event.target.tagName.toLowerCase() !== 'input' && event.target.tagName.toLowerCase() !== 'button') {

					// Lấy giá trị của thuộc tính data-id của thẻ <tr> được bấm
					var itemId = tr.getAttribute('data-id');
					var itemType = tr.getAttribute('data-type');

					// Gửi yêu cầu AJAX để lấy nội dung view từ server
					fetch('/WareHouse/DetailTransaction', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ id: itemId, type: itemType })  // Chuyển đổi itemId thành một đối tượng JSON
					})
						.then(response => response.text())
						.then(data => {
							// Điền nội dung vào modal
							document.getElementById('modal-body-content').innerHTML = data;

							// Hiển thị modal
							var modal = new bootstrap.Modal(document.getElementById('infoModal'));
							modal.show();
						})
						.catch(error => console.error('Error:', error));
				}
			});
		});
	});
</script>
